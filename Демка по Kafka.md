По результатам чтения [[Книга «Kafka в действии», Дилан Скотт, Виктор Гамов, Дейв Клейн]] (но в большей степени по результатам отдельной проработки).

# Что такое Apache Kafka?

Что такое Apache Kafka? Это продвинутый брокер сообщений. То есть существует много программ, которые являются брокерами сообщений, например, RabbitMQ, Redis Streams, ZeroMQ и другие.

Что такое брокер сообщений? Это программа, которая служит посредником при коммуникации разных систем. Говоря по-простому, одна система записывает сообщения в брокер, а другая система считывает эти сообщения из брокера.

Само слово брокер пошло из финансовой среды, где брокер это посредник между покупателем и продавцом. Например, Волк с Уолл-стрит это брокер. В IT это посредник между отправляющей и принимающей системой.

Почему просто не послать запрос от одной системы в другую и нафига нам тут посредник?

Потому что иногда, во-первых, очень удобна именно асинхронная связь, когда одной системе не надо ждать ответа от другой системы.

Во-вторых, когда есть посредник, то отправляющая система и принимающая системы могут вообще не знать друг о друге, что сильно их развязывает. То есть связь этих систем получается слабая, а это очень хорошо. Слабая связь между компонентами большой системы это прекрасно.

Система отправляет событие и ей неважно, кто как его обработает и обработает ли вообще кто-то. Это событие записалось в брокер и какая-то другая система или несколько систем смогут считать из брокера это событие и как-то обработать. При этом кто положил это событие в брокер эти принимающие системы тоже не знают. Просто возникло событие, например, появился новый заказ в ИМ, это событие падает в брокер, и какая-то система, какой-то микросервис, ловит из брокера это событие и обрабатывает, например, отправляет email-сообщение клиенту. Другой микросервис тоже ловит это событие и идёт бронировать товар на склад. И так далее.

В-третьих, брокер может использоваться как потоковая система обработки данных в противовес пакетной обработке данных. Частая схема, когда какие-то выгрузки осуществляются раз в сутки, например. По крону запускается процесс и раз в сутки какие-то данные откуда-то забирает, обрабатывает и куда-то кладёт. Сейчас это не всегда удобно и потоковая система как раз позволяет делать это в реальном времени. Данные при возникновении не собираются в пакет, а кладутся сразу в брокер и сразу могут быть из брокера получены принимающей стороной и обработаны.

Не все брокеры настолько мощны, что их можно назвать потоковой системой обработки данных, но кафка сюда относится.

В-четвертых, брокер может выступать как балансировщик нагрузки. Возникло событие и его может взять обработать любой воркер, то есть любой экземпляр сервиса обработчика. У нас мало заказов — мы подняли одного воркера, который бронирует товары на складе. Стало больше заказов — подняли второго воркера, третьего и так далее. Они просто берут заказы на обработку из брокера и работают. Очень красиво и можно легко горизонтально масштабироваться, просто плодя воркеров в нужном количестве.

В-пятых, принимающая система может сломаться, но сообщение из воркера никуда не пропадёт. Принимающая система поднимется и считает новые необработанные сообщения и обработает их. В случае синхронной связи без посредника, если принимающая сторона лежит, то досвидули — весь процесс падает, мы не можем двигаться дальше. В случае с асинхронной связью и посредником весь процесс не ломается и данные просто обработаются позже.

Отличий Кафки от этих брокеров вроде RabbitMQ, Redis Streams и пр. много.

Кафка отлично горизонтально масштабируется в отличие от других брокеров. Возможность горизонтального дублирования изначально заложено в архитектуру Кафка, это одна из её фундаментальных фич.

Кафка хранит данные постоянно. Скажем, RabbitMQ используется в основном как очередь, то есть один потребитель считал значение из очереди и всё, этого значения в очереди больше нет. В кафке сообщение не удаляется после считывания и его можно считать еще раз другим потребителем или даже спустя какое-то время считать исторические старые данные, чтобы восстановить состояние системы на какой-то период времени в прошлом, например.

Например, микросервис считал данные, но в процессе их обработки возникла ошибка и микросервис упал, не закончив обработку. Вот из кафки не проблема считать данные заново и заново обработать. Или, повторюсь, считать даже через пол года и обработать заново. Очень удобно. Данные могут храниться вечно или удаляться по истечению какого-то срока времени или по нехватке места на диске при необходимости.

Задача потоковой обработки большого объёма данных, это тоже основная задача Kafka, кафка создавалась с прицелом на это. Высочайшая пропускная способность это про кафку, но не всегда про другие брокеры.

# Основные концепции

Окей, про кафку поняли. Поговорим про основные концепции кафки.

