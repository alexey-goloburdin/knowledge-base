Как хранит данные Postgres и как использовать это знание для увеличения производительности запросов?

## Как работает Postgres

Где лежат все файлы баз данных? Они лежат в хранилище, которое называют кластером баз данных. Документация гласит, что 

> Кластер баз данных представляет собой набор баз, управляемых одним экземпляром работающего сервера.

То есть в постгресе кластер это не набор серверов с репликацией и так далее. Когда вы на один компьютер устанавливаете Postgres, то в процессе установки автоматически или вручную происходит инициализация кластера, то есть инициализация этой директории, в которой будут храниться данные всех баз данных.

Ну так вот, место на диске, где хранятся эти файлы, можно посмотреть в параметре 

```sql
SHOW data_directory;
```

На выполнение этого запроса необходимы права, от обычного пользователя он не сработает, поэтому можно запустить от пользователя `postgres`.

Как посмотреть, где лежат данные БД?

Данные БД могут лежать в разных табличных пространствах, то есть разных директориях, а как мы помним в linux мы можем примонтировать в директорию целый диск. То есть одни таблицы могут быть на медленных больших дисках, а другие таблицы могут быть на быстрых, но возможно меньших по размеру дисках.

Если используется стандартное табличное пространство, 

Как посмотреть, где лежат данные таблицы?

```sql
select pg_relation_filepath('wide_employee');
```


## Дальше


```sql
-- from postgres user
create extension pg_buffercache;

-- see used and unused buffers count
select * from pg_buffercache_summary();

show work_mem;
set work_mem='128MB';

EXPLAIN (analyze, buffers)
SELECT employee_id, first_name, last_name FROM wide_employee where department_id='HR' order by employment_date limit 20;
-- Buffers: shared hit=114 read=248062
-- Execution Time: 1370.851 ms
-- памяти work_mem хватает

-- sudo systemctl restart postgresql
EXPLAIN (analyze, buffers)

SELECT e.employee_id, e.first_name, e.last_name
FROM employee e
JOIN employee_hierarchy eh ON e.employee_id = eh.employee_id
WHERE department_id='HR' order by employment_date limit 20;
-- уходим в файловый кеш, ребутаем и поднимаем work_mem до 128MB
-- Buffers: shared hit=138 read=85877
-- Execution Time: 1453.068 ms



```

Разнести по разным СУБД два сценария
Сравнить размер СУБД (с учетом индексов PK)
Сказать про сценарий является и владеет (или как-то так)

[[Сценарий]]